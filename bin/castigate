#!/usr/bin/env ruby

require "rubygems"

require "optparse"
require "castigate/repo"
require "castigate/version"

command, dir = nil

OptionParser.new do |opts|
  opts.banner = "castigate [-r cmd] <repo-dir>"
  opts.separator ""

  opts.on "--run [command]", "-r", "Run for each revision." do |cmd|
    command = cmd
  end

  opts.on "--help", "-h", "-?", "Show this help." do
    puts opts
    exit
  end

  opts.on "--verbose", "-v", "Show progress messages." do
    $verbose = true
  end

  opts.on "--version", "-V", "Show castigate version." do
    puts Castigate::VERSION
    exit
  end

  opts.separator ""
  opts.parse! ARGV

  unless dir = ARGV.first
    puts opts
    exit 1
  end
end

repo = Castigate::Repo.new dir

# FIXME: bad exception
raise "Only run on a clean repo!" unless repo.clean?


if command
  repo.each_commit do |commit|
    system "COMMIT=#{commit.id} ; #{command}"
  end
else
  require "fastercsv"

  FCSV do |csv|
    csv << Castigate::Repo::COLUMNS

    repo.abuse.each do |row|
      row[:commit_time] = row[:commit_time].strftime "%Y-%m-%d %H:%M"
      csv << Castigate::Repo::COLUMNS.collect { |c| row[c.to_sym] }
    end
  end
end
